//=============================================================================
// People Analytics Measures Script CLAUDE SONNET 3.5
// Description: This script defines various measures and KPIs for People Analytics
// including overtime, absenteeism, and hour bank calculations.
//
// Main sections:
// 1. Overtime Measures
//    - Total overtime hours
//    - Average overtime costs
//    - Overtime percentages YoY and MoM
//    - Eligible/ineligible people for overtime
//
// 2. Absenteeism Measures
//    - Total absence days
//    - Unplanned absences
//    - Absenteeism rates and indexes
//    - YoY and MoM comparisons
//    - Leave types (medical, unexcused, delays)
//
// 3. Hour Bank Measures
//    - Hour bank balances
//    - Positive/negative hour bank totals
//    - Payment calculations for March/September
//
// Dependencies:
//  - Requires gd_eventos_f table
//  - Date fields must be in DD.MM.YYYY format
//  
// Notes:
//  - All measures use Set Analysis for precise time period calculations
//  - Calculations include both current and previous year comparisons
//  - Special handling for March/September hour bank payments
//=============================================================================


/** GEMINI 2.0 FLASH
 * @title People Analytics Measures Script
 * @description This script calculates various People Analytics measures related to overtime, absenteeism, and time-off (banked hours).
 * It defines SET statements to calculate metrics, including costs, hours, percentages, and trends (MoM and YoY) for each category.
 * The script uses data from the `gd_eventos_f` table and relies on specific event types and flags to filter and aggregate the data.
 *
 * @includes
 *  - Overtime Measures: Calculates total overtime hours, costs, and related metrics.
 *  - Absenteeism Measures: Calculates absenteeism rates, unplanned absence hours, and associated costs.
 *  - Time-Off (Banked Hours) Measures: Calculates the balance of banked hours and related metrics.
 *
 * @variables
 *  - horas_total_extras: Total overtime hours.
 *  - horas_extras_atual: Overtime hours for the current period.
 *  - horas_extras_anterior: Overtime hours for the previous period.
 *  - custo_medio_he: Average cost of overtime.
 *  - custo_medio_he_ano_anterior: Average cost of overtime in the previous year.
 *  - custo_medio_he_ano_atual: Average cost of overtime in the current year.
 *  - custo_medio_por_pessoa_he: Average overtime cost per person.
 *  - media_he: Average overtime hours.
 *  - pessoas_elegiveis_he: Number of employees eligible for overtime.
 *  - pessoas_com_registro_he: Number of employees with overtime records.
 *  - pessoas_inelegiveis_he: Number of employees ineligible for overtime.
 *  - qtd_eventos_he: Number of overtime events.
 *  - qtd_media_he_por_pessoa: Average number of overtime events per person.
 *  - valor_evento_hora_extra_recorrente: Value of recurring overtime events.
 *  - valor_evento_horas_extras_esporadicas: Value of sporadic overtime events.
 *  - %_HE_pessoas_elegiveis: Percentage of eligible employees with overtime.
 *  - %_HE_pessoas_inelegiveis: Percentage of ineligible employees with overtime.
 *  - %_HE_remuneracao_total: Percentage of overtime in total compensation.
 *  - %_hora_extra_esporadica: Percentage of sporadic overtime.
 *  - %_hora_extra_recorrente: Percentage of recurring overtime.
 *  - %_MoM_horas_extras_custo_medio_he: Month-over-month change in average overtime cost.
 *  - %_YoY_custo_medio_he: Year-over-year change in average overtime cost.
 *  - %_HE_total_horas_trabalhadas: Percentage of overtime in total worked hours.
 *  - %_YoY_horas_extras_valor: Year-over-year change in overtime value.
 *  - %_YoY_hora_extra: Year-over-year change in overtime hours.
 *  - %_MoM_horas_extras: Month-over-month change in overtime hours.
 *  - %MoM_hora_extra_valor: Month-over-month change in overtime value.
 *  - valor_evento_horas_extras: Total value of overtime events.
 *  - valor_eventos_horas_extras_ano_atual: Total value of overtime events in the current year.
 *  - valor_eventos_horas_extras_ano_anterior: Total value of overtime events in the previous year.
 *  - valor_evento_hora_extra_recorrente: Value of recurring overtime events.
 *  - valor_evento_horas_extras_anterior: Total value of overtime events in the previous period.
 *  - valor_evento_horas_extras_atual: Total value of overtime events in the current period.
 *  - valor_evento_hora_extra_grafico: Value of overtime events for the chart.
 *  - dias_absenteismo: Total days of absenteeism.
 *  - dias_nao_planejados: Total days of unplanned absences.
 *  - dias_abonos: Days of excused absence.
 *  - dias_atestado: Days of sick leave.
 *  - dias_faltas: Days of unexcused absence.
 *  - dias_reembolso: Days of reimbursement.
 *  - dia_atraso: Days of lateness.
 *  - eventos_absenteismo: Absenteeism events.
 *  - horas_total_absenteismo: Total hours of absenteeism.
 *  - horas_nao_planejadas: Unplanned absence hours.
 *  - horas_total_abonos: Total hours of excused absence.
 *  - media_faltantes: Average days of absence.
 *  - %_indice_absenteismo: Absenteeism rate.
 *  - %_indice_absenteismo_ano_anterior: Absenteeism rate in the previous year.
 *  - %_indice_absenteismo_ano_atual: Absenteeism rate in the current year.
 *  - %_indice_absenteismo_grafico: Absenteeism rate for the chart.
 *  - %_indice_horas_nao_planejadas: Unplanned absence hours rate.
 *  - %_indice_absenteismo_nao_planejado_ano_anterior: Unplanned absenteeism rate in the previous year.
 *  - %_indice_absenteismo_nao_planejado_ano_atual: Unplanned absenteeism rate in the current year.
 *  - %_MoM_absenteismo: Month-over-month change in absenteeism rate.
 *  - %_YoY_absenteismo: Year-over-year change in absenteeism rate.
 *  - %_YoY_horas_nao_planejadas: Year-over-year change in unplanned absence hours.
 *  - %_MoM_horas_nao_planejadas: Month-over-month change in unplanned absence hours.
 *  - %_horas_nao_planejadas_tabela_atual: Unplanned absence hours rate for the current table.
 *  - %_horas_nao_planejadas_tabela_ant: Unplanned absence hours rate for the previous table.
 *  - %_YoY_horas_nao_planejadas_tabela: Year-over-year change in unplanned absence hours rate for the table.
 *  - valor_eventos_faltas: Value of absence events.
 *  - valor_eventos_falta_ano_atual: Value of absence events in the current year.
 *  - valor_eventos_falta_ano_anterior: Value of absence events in the previous year.
 *  - valor_evento_faltas_operacional: Value of absence events for operational staff.
 *  - valor_evento_faltas_nao_operacional: Value of absence events for non-operational staff.
 *  - %_MoM_valor_total_faltas: Month-over-month change in total absence value.
 *  - %_YoY_valor_total_faltas: Year-over-year change in total absence value.
 *  - valor_evento_falta_grafico: Value of absence events for the chart.
 *  - %_indice_abono: Excused absence rate.
 *  - %_indice_abono_ano_atual: Excused absence rate in the current year.
 *  - %_indice_abono_ano_anterior: Excused absence rate in the previous year.
 *  - %YoY_indice_abono: Year-over-year change in excused absence rate.
 *  - %MoM_indice_abono: Month-over-month change in excused absence rate.
 *  - %_abonos_atual_grafico: Excused absence rate for the current chart.
 *  - %_abono_anterior_grafico: Excused absence rate for the previous chart.
 *  - valor_evento_saldo_banco_pago: Value of time-off (banked hours) paid.
 *  - %_colaboradores_com_saldo_banco: Percentage of employees with time-off (banked hours) balance.
 *  - %_MAR_SET_pgt_banco: Percentage of time-off (banked hours) paid in March and September.
 *  - horas_total_saldo_banco: Total time-off (banked hours).
 *  - horas_total_saldo_banco_positivo: Total positive time-off (banked hours).
 *  - horas_total_saldo_banco_negativo: Total negative time-off (banked hours).
 *
 * @remarks
 *  - The script uses a combination of SET statements and calculated expressions to derive the measures.
 *  - Date calculations rely on the `gd_eventos_f.load_date` field and the `Only(GetFieldSelections(gd_eventos_f.load_date))` function to determine the selected date range.
 *  - The script includes logic to handle year-over-year (YoY) and month-over-month (MoM) comparisons.
 *  - The script uses the TRACE statement to log the start of each section.
 *  - The script ends with an EXIT SCRIPT statement.
 *
 * @file People Analytics Measures.qvs
 * @filepath /c:/Users/ext.saraOM/Desktop/documentacao/documenta-o/SCRIPT PARA IMPLEMENTACAO/People Analytics Measures.qvs
 */



TRACE >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>Iniciando carregamento medidas de Hora extra<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<;
SET horas_total_extras = '{<tipo_evento={''Hora extra''}>} [#_hora_total]';
 
SEt horas_extras_atual = '{<gd_eventos_f.load_date = {"=$(=Date(AddMonths(Date#(MonthStart(Only(GetFieldSelections(gd_eventos_f.load_date))), ''DD.MM.YYYY''),1), ''DD.MM.YYYY''))"},ano = {"=$(=Year(Date#(Only(gd_eventos_f.load_date), ''DD.MM.YYYY'')))"}>} [#_horas_total_extras]';
 
SET horas_extras_anterior = '{<gd_eventos_f.load_date = {"=$(=Date(AddMonths(Date#(MonthStart(Only(GetFieldSelections(gd_eventos_f.load_date))), ''DD.MM.YYYY''),1), ''DD.MM.YYYY''))"},ano = {"$(=Year(AddYears(Date#(Only(gd_eventos_f.load_date), ''DD.MM.YYYY''), -1)))"}>} [#_horas_total_extras]';
 
SET custo_medio_he = '{<tipo_evento={''Hora extra''}, flag_hora_extra={''1''}>} [#_valor_evento_total] / count({<flag_hora_extra={''1''}>} gd_eventos_f.hora_total)';
 
SET custo_medio_he_ano_anterior = '{<gd_eventos_f.load_date = {"=$(=Date(AddMonths(Date#(MonthStart(Only(GetFieldSelections(gd_eventos_f.load_date))), ''DD.MM.YYYY''),1), ''DD.MM.YYYY''))"},ano = {"$(=Year(AddYears(Date#(Only(gd_eventos_f.load_date), ''DD.MM.YYYY''), -1)))"}>}[#_custo_medio_he]';
 
SET custo_medio_he_ano_atual = '{<[gd_eventos_f.load_date] = {"=$(=Date(AddMonths(Date#(MonthStart(Only(GetFieldSelections(gd_eventos_f.load_date))), ''DD.MM.YYYY''),1), ''DD.MM.YYYY''))"}, ano = {"=$(=Year(Date#(Only(gd_eventos_f.load_date), ''DD.MM.YYYY'')))"}>}[#_custo_medio_he]';
 
SET custo_medio_por_pessoa_he = '[#_valor_evento_horas_extras]/[#_pessoas_com_registro_he]';
 
SET media_he = '{<flag_hora_extra={''1''}>}[#_horas_total_extras]/count({<flag_hora_extra={''1''}>} gd_eventos_f.hora_total)';
 
SET pessoas_elegiveis_he= 'count({<flag_hora_extra={''1''}, grupo_relatorio={''8 - Demais''}>}distinct pessoa)';
 
SET pessoas_com_registro_he = 'count({<flag_hora_extra={''1''}>}distinct pessoa)';
 
SET pessoas_inelegiveis_he = 'count({<flag_hora_extra={''1''}, grupo_relatorio-={''8 - Demais''}>}distinct pessoa)';
 
SET qtd_eventos_he= 'count({<flag_hora_extra={''1''}>} gd_eventos_f.hora_total)';
 
SET qtd_media_he_por_pessoa = '[#_qtd_eventos_he]/[#_pessoas_com_registro_he]';
 
SET valor_evento_hora_extra_recorrente = '{<nome_conta_debito={''Recorrente''}>}[#_valor_evento_horas_extras]';
 
SET valor_evento_horas_extras_esporadicas = '{<nome_conta_debito={''Esporádico''}>}[#_valor_evento_horas_extras]';
 
SET %_HE_pessoas_elegiveis = '[#_pessoas _elegiveis_he]/[#_pessoas_com_registro_he]';
 
SET %_HE_pessoas_inelegiveis = '([#_pessoas_com_registro_he] - [#_pessoas _elegiveis_he])/[#_pessoas_com_registro_he]';
 
SET %_HE_remuneracao_total = '([#_valor_evento_horas_extras])/(({<flag_hora_extra={''1''}, grupo_relatorio={''4 - Coordenador'',''8 - Demais''}>}[#_salario]) +  [#_valor_evento_horas_extras])';
 
SET %_hora_extra_esporadica = '[#_valor_evento_horas_extras_esporadicas]/[#_valor_evento_horas_extras]';
 
SET %_hora_extra_recorrente = '[#_valor_evento_hora_extra_recorrente]/[#_valor_evento_horas_extras]';
 
SET %_MoM_horas_extras_custo_medio_he = '(({<gd_eventos_f.load_date={">=$(=Date(MonthStart(Max(gd_eventos_f.load_date)), ''DD.MM.YYYY''))<=$(=Date(MonthEnd(Max(gd_eventos_f.load_date)), ''DD.MM.YYYY''))"}>} [#_custo_medio_he])
-
                                        ({<gd_eventos_f.load_date={">=$(=Date(MonthStart(AddMonths(Max(gd_eventos_f.load_date), -1)), ''DD.MM.YYYY''))<=$(=Date(MonthEnd(AddMonths(Max(gd_eventos_f.load_date), -1)), ''DD.MM.YYYY''))"}>} [#_custo_medio_he]))
/
                                        ({<gd_eventos_f.load_date={">=$(=Date(MonthStart(AddMonths(Max(gd_eventos_f.load_date), -1)), ''DD.MM.YYYY''))<=$(=Date(MonthEnd(AddMonths(Max(gd_eventos_f.load_date), -1)), ''DD.MM.YYYY''))"}>} [#_custo_medio_he])';
 
 
SET %_YoY_custo_medio_he = '(({<gd_eventos_f.load_date={">=$(=Date(YearStart(Max(gd_eventos_f.load_date)), ''DD.MM.YYYY'')) <=$(=Date(YearEnd(Max(gd_eventos_f.load_date)), ''DD.MM.YYYY''))"}>} [#_custo_medio_he])
    -
({<gd_eventos_f.load_date = {">=$(=Date(YearStart(AddYears(Max(gd_eventos_f.load_date), -1)), ''DD.MM.YYYY''))<=$(=Date(YearEnd(AddYears(Max(gd_eventos_f.load_date), -1)), ''DD.MM.YYYY''))"}>} [#_custo_medio_he]))
/
({<gd_eventos_f.load_date = {">=$(=Date(YearStart(AddYears(Max(gd_eventos_f.load_date), -1)), ''DD.MM.YYYY'')) <=$(=Date(YearEnd(AddYears(Max(gd_eventos_f.load_date), -1)), ''DD.MM.YYYY''))"}>} [#_custo_medio_he])';
 
 
SET %_HE_total_horas_trabalhadas = '[#_horas_total_extras]/([#_horas_total_jornada_mensal] + [#_horas_total_extras])';
 
SET %_YoY_horas_extras_valor  = '({<gd_eventos_f.load_date={">=$(=Date(YearStart(Max(gd_eventos_f.load_date)), ''DD.MM.YYYY'')) <=$(=Date(YearEnd(Max(gd_eventos_f.load_date)), ''DD.MM.YYYY''))"}>} [#_valor_evento_horas_extras])
-
({<gd_eventos_f.load_date = {">=$(=Date(YearStart(AddYears(Max(gd_eventos_f.load_date), -1)), ''DD.MM.YYYY''))<=$(=Date(YearEnd(AddYears(Max(gd_eventos_f.load_date), -1)), ''DD.MM.YYYY''))"}>} [#_valor_evento_horas_extras]))
/
({<gd_eventos_f.load_date = {">=$(=Date(YearStart(AddYears(Max(gd_eventos_f.load_date), -1)), ''DD.MM.YYYY'')) <=$(=Date(YearEnd(AddYears(Max(gd_eventos_f.load_date), -1)), ''DD.MM.YYYY''))"}>} [#_valor_evento_horas_extras])';
 
 
SET %_YoY_hora_extra =  '({<gd_eventos_f.load_date={">=$(=Date(YearStart(Max(gd_eventos_f.load_date)), ''DD.MM.YYYY'')) <=$(=Date(YearEnd(Max(gd_eventos_f.load_date)), ''DD.MM.YYYY''))"}>} #_horas_total_extras)
-
Sum({<gd_eventos_f.load_date = {">=$(=Date(YearStart(AddYears(Max(gd_eventos_f.load_date), -1)), ''DD.MM.YYYY''))<=$(=Date(YearEnd(AddYears(Max(gd_eventos_f.load_date), -1)), ''DD.MM.YYYY''))"}>} #_horas_total_extrasl))
/
Sum({<gd_eventos_f.load_date = {">=$(=Date(YearStart(AddYears(Max(gd_eventos_f.load_date), -1)), ''DD.MM.YYYY'')) <=$(=Date(YearEnd(AddYears(Max(gd_eventos_f.load_date), -1)), ''DD.MM.YYYY''))"}>} #_horas_total_extras)';
 
 
SET %_MoM_horas_extras = '(({<gd_eventos_f.load_date = {">=$(=Date(Monthstart(Max(gd_eventos_f.load_date)), ''DD.MM.YYYY''))<=$(=Date(MonthEnd(Max(gd_eventos_f.load_date)), ''DD.MM.YYYY''))"}>} #_horas_total_extras) -
Sum({<gd_eventos_f.load_date = {">=$(=Date(MonthStart(AddMonths(Max(gd_eventos_f.load_date), -1)), ''DD.MM.YYYY''))<=$(=Date(Monthend(AddMonths(Max(gd_eventos_f.load_date), -1)), ''DD.MM.YYYY''))"}>} #_horas_total_extras))
/
Sum({<gd_eventos_f.load_date = {">=$(=Date(MonthStart(AddMonths(Max(gd_eventos_f.load_date), -1)), ''DD.MM.YYYY''))<=$(=Date(Monthend(AddMonths(Max(gd_eventos_f.load_date), -1)), ''DD.MM.YYYY''))"}>} #_horas_total_extras)';
 
 
SET %MoM_hora_extra_valor = '({<gd_eventos_f.load_date = {">=$(=Date(Monthstart(Max(gd_eventos_f.load_date)), ''DD.MM.YYYY''))<=$(=Date(MonthEnd(Max(gd_eventos_f.load_date)), ''DD.MM.YYYY''))"}>} valor_evento_horas_extras) -
({<gd_eventos_f.load_date = {">=$(=Date(MonthStart(AddMonths(Max(gd_eventos_f.load_date), -1)), ''DD.MM.YYYY''))<=$(=Date(Monthend(AddMonths(Max(gd_eventos_f.load_date), -1)), ''DD.MM.YYYY''))"}>}valor_evento_horas_extras))
/
({<gd_eventos_f.load_date = {">=$(=Date(MonthStart(AddMonths(Max(gd_eventos_f.load_date), -1)), ''DD.MM.YYYY''))<=$(=Date(Monthend(AddMonths(Max(gd_eventos_f.load_date), -1)), ''DD.MM.YYYY''))"}>} valor_evento_horas_extrasl)';
 
 
SET valor_evento_horas_extras =  '{<tipo_evento={''Hora extra''}>} [#_valor_evento_total]';
 
SET valor_eventos_horas_extras_ano_atual = '{<gd_eventos_f.load_date = {"=$(=Date(AddMonths(Date#(MonthStart(Only(GetFieldSelections(gd_eventos_f.load_date))), ''DD.MM.YYYY''),1), ''DD.MM.YYYY''))"},ano = {"=$(=Year(Date#(Only(gd_eventos_f.load_date), ''DD.MM.YYYY'')))"}>}[#_valor_evento_horas_extras]';
 
SET valor_eventos_horas_extras_ano_anterior = '{<gd_eventos_f.load_date = {"=$(=Date(AddMonths(Date#(MonthStart(Only(GetFieldSelections(gd_eventos_f.load_date))), ''DD.MM.YYYY''),1), ''DD.MM.YYYY''))"},ano = {"$(=Year(AddYears(Date#(Only(gd_eventos_f.load_date), ''DD.MM.YYYY''), -1)))"}>}[#_valor_evento_horas_extras]';
 
 
SET valor_evento_hora_extra_recorrente = '{<nome_conta_debito={''Recorrente''}>}[#_valor_evento_horas_extras]';
 
SET valor_evento_horas_extras_anterior= '{<gd_eventos_f.load_date = {"=$(=Date(AddMonths(Date#(MonthStart(Only(GetFieldSelections(gd_eventos_f.load_date))), ''DD.MM.YYYY''),1), ''DD.MM.YYYY''))"},ano = {"$(=Year(AddYears(Date#(Only(gd_eventos_f.load_date), ''DD.MM.YYYY''), -1)))"}>} [#_valor_evento_horas_extras]';
 
SET valor_evento_horas_extras_atual = '{<gd_eventos_f.load_date = {"=$(=Date(AddMonths(Date#(MonthStart(Only(GetFieldSelections(gd_eventos_f.load_date))), ''DD.MM.YYYY''),1), ''DD.MM.YYYY''))"},ano = {"=$(=Year(Date#(Only(gd_eventos_f.load_date), ''DD.MM.YYYY'')))"}>}[#_valor_evento_horas_extras]';
 
SET valor_evento_hora_extra_grafico = '{<gd_eventos_f.load_date = {"=$(=Date(AddMonths(Date#(MonthStart(Only(GetFieldSelections(gd_eventos_f.load_date))), ''DD.MM.YYYY''),1), ''DD.MM.YYYY''))"},ano = {"=$(=Year(Date#(Only(gd_eventos_f.load_date), ''DD.MM.YYYY'')))"}>}[#_valor_evento_horas_extras]';
 
 TRACE >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>Iniciando carregamento medidas de Absenteísmo  <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<;
 
 
SET dias_absenteismo =  '[#_dias_atestado]+ [#_dias_faltas] +[#_dia_atraso] +[#_dias_abonos]';
 
SET dias_nao_planejados = '[#_dias_faltas] + [#_dia_atraso]';
 
SET dias_abonos = 'Sum(aggr(sum({<tipo_evento = {''Abonos''}>} gd_eventos_f.hora_total) * 30 / sum({<tipo_evento = {''Jornada''}>} distinct gd_eventos_f.hora_total),mes_nome, gd_eventos_f.chapa))';
 
SET dias_atestado = 'Sum(aggr(sum({<tipo_evento = {''Atestado''}>} [gd_eventos_f.hora_total]) * 30 

    / 

    sum({<tipo_evento = {''Jornada''}>} distinct [gd_eventos_f.hora_total]),gd_eventos_f.chapa, (mes_nome)))';
 
 
SEt dias_faltas = 'Sum(aggr(sum({<tipo_evento = {''Falta''}>} [gd_eventos_f.hora_total]) * 30 

    / 

    sum({<tipo_evento = {''Jornada''}>} distinct [gd_eventos_f.hora_total]),gd_eventos_f.chapa, (mes_nome)))';
 
 
SET dias_reembolso = 'Sum(aggr(sum({<tipo_evento = {''Reembolso''}>} [gd_eventos_f.hora_total]) * 30 

    / 

    sum({<tipo_evento = {''Jornada''}>} distinct [gd_eventos_f.hora_total]),mes_nome, gd_eventos_f.chapa))';
 
 
SET dia_atraso = 'Sum(aggr(sum({<tipo_evento = {''Atraso''}>} [gd_eventos_f.hora_total]) * 30 

  / 

   sum({<tipo_evento = {''Jornada''}>} distinct [gd_eventos_f.hora_total]),mes_nome, [gd_eventos_f.chapa]))';

 
SET eventos_absenteismo = '{<tipo_evento-={''Jornada'',''Hora extra'', ''Abonos'', ''Saldo Banco'',''Reembolso''}>}[#_hora_total]';
 
SET horas_total_absenteismo = '[#_horas_total_atestado] + [#_horas_total_atrasos] + [#_horas_total_faltas] + [#_horas_total_abonos]';
 
SET horas_nao_planejadas = '[#_horas_total_faltas] + [#_horas_total_atrasos]';
 
SET horas_total_abonos = '{<tipo_evento={''Abonos''}>} [#_hora_total]';
 
SET media_faltantes = 'num(([#_dias_faltas] +[#_dia_atraso])/count({<flag_horas_nao_planejadas={''1''}>}distinct pessoa),''#,##'') & '' dias''';
 
 
SET %_indice_absenteismo = '[#_horas_total_absenteismo]/[#_horas_total_jornada_mensal]';
 
 
SET %_indice_absenteismo_ano_anterior = '{<gd_eventos_f.load_date = {"=$(=Date(AddMonths(Date#(MonthStart(Only(GetFieldSelections(gd_eventos_f.load_date))), ''DD.MM.YYYY''),1), ''DD.MM.YYYY''))"}, ano = {"$(=Year(AddYears(Date#(Only(gd_eventos_f.load_date), ''DD.MM.YYYY''), -1)))"}>} [#_horas_total_absenteismo]

/

{< gd_eventos_f.load_date = {"=$(=Date(AddMonths(Date#(MonthStart(Only(GetFieldSelections(gd_eventos_f.load_date))), ''DD.MM.YYYY''),1), ''DD.MM.YYYY''))"},ano = {"$(=Year(AddYears(Date#(Only(gd_eventos_f.load_date), ''DD.MM.YYYY''), -1)))"}>} [#_horas_total_jornada_mensal]';
 
 
SET %_indice_absenteismo_ano_atual= '{< [gd_eventos_f.load_date] = {"=$(=Date(AddMonths(Date#(MonthStart(Only(GetFieldSelections(gd_eventos_f.load_date))), ''DD.MM.YYYY''),1), ''DD.MM.YYYY''))"},ano = {"=$(=Year(Date#(Only(gd_eventos_f.load_date), ''DD.MM.YYYY'')))"}>} [#_horas_total_absenteismo]

/{<gd_eventos_f.load_date = {"=$(=Date(AddMonths(Date#(MonthStart(Only(GetFieldSelections(gd_eventos_f.load_date))), ''DD.MM.YYYY''),1), ''DD.MM.YYYY''))"},ano = {"=$(=Year(Date#(Only(gd_eventos_f.load_date), ''DD.MM.YYYY'')))"}
>} [#_horas_total_jornada_mensal]';
 
 
SET %_indice_absenteismo_grafico = '({< [gd_eventos_f.load_date] = {"=$(=Date(AddMonths(Date#(MonthStart(Only(GetFieldSelections(gd_eventos_f.load_date))), ''DD.MM.YYYY''),1), ''DD.MM.YYYY''))"},ano = {"=$(=Year(Date#(Only(gd_eventos_f.load_date), ''DD.MM.YYYY'')))"}>} [#_horas_total_absenteismo])

/

({<gd_eventos_f.load_date = {"=$(=Date(AddMonths(Date#(MonthStart(Only(GetFieldSelections(gd_eventos_f.load_date))), ''DD.MM.YYYY''),1), ''DD.MM.YYYY''))"},ano = {"=$(=Year(Date#(Only(gd_eventos_f.load_date), ''DD.MM.YYYY'')))"}>} [#_horas_total_jornada_mensal])';
 
SET %_indice_horas_nao_planejadas = '#_horas_nao_planejadas/[#_horas_total_jornada_mensal]';
 
SET %_indice_absenteismo_nao_planejado_ano_anterior= '{<gd_eventos_f.load_date = {"=$(=Date(AddMonths(Date#(MonthStart(Only(GetFieldSelections(gd_eventos_f.load_date))), ''DD.MM.YYYY''),1), ''DD.MM.YYYY''))"},

  ano = {"$(=Year(AddYears(Date#(Only(gd_eventos_f.load_date), ''DD.MM.YYYY''), -1)))"}>} [#_horas_nao_planejadas]

/

{<gd_eventos_f.load_date = {"=$(=Date(AddMonths(Date#(MonthStart(Only(GetFieldSelections(gd_eventos_f.load_date))), ''DD.MM.YYYY''),1), ''DD.MM.YYYY''))"},

  ano = {"$(=Year(AddYears(Date#(Only(gd_eventos_f.load_date), ''DD.MM.YYYY''), -1)))"}
>} [#_horas_total_jornada_mensal]';
 
 
SET %_indice_absenteismo_nao_planejado_ano_atual = '{<gd_eventos_f.load_date = {"=$(=Date(AddMonths(Date#(MonthStart(Only(GetFieldSelections(gd_eventos_f.load_date))), ''DD.MM.YYYY''),1), ''DD.MM.YYYY''))"},ano = {"=$(=Year(Date#(Only(gd_eventos_f.load_date), ''DD.MM.YYYY'')))"}>} [#_horas_nao_planejadas]

/

{<gd_eventos_f.load_date = {"=$(=Date(AddMonths(Date#(MonthStart(Only(GetFieldSelections(gd_eventos_f.load_date))), ''DD.MM.YYYY''),1), ''DD.MM.YYYY''))"},ano = {"=$(=Year(Date#(Only(gd_eventos_f.load_date), ''DD.MM.YYYY'')))"}>} [#_horas_total_jornada_mensal]';
 
 
SET %_MoM_absenteismo = '({<gd_eventos_f.load_date = {">=$(=Date(Monthstart(Max(gd_eventos_f.load_date)), ''DD.MM.YYYY''))<=$(=Date(MonthEnd(Max(gd_eventos_f.load_date)), ''DD.MM.YYYY''))"}>} [%_indice_absenteismo] -

{<gd_eventos_f.load_date = {">=$(=Date(MonthStart(AddMonths(Max(gd_eventos_f.load_date), -1)), ''DD.MM.YYYY''))<=$(=Date(Monthend(AddMonths(Max(gd_eventos_f.load_date), -1)), ''DD.MM.YYYY''))"}>}[%_indice_absenteismo])

/

({<gd_eventos_f.load_date = {">=$(=Date(MonthStart(AddMonths(Max(gd_eventos_f.load_date), -1)), ''DD.MM.YYYY''))<=$(=Date(Monthend(AddMonths(Max(gd_eventos_f.load_date), -1)), ''DD.MM.YYYY''))"}>}[%_indice_absenteismo])'

;
 
SET %_YoY_absenteismo=  '({<[gd_eventos_f.load_date] = {">=$(=Date(YearStart(Max(gd_eventos_f.load_date)), ''DD.MM.YYYY'')) <=$(=Date(YearEnd(Max(gd_eventos_f.load_date)), ''DD.MM.YYYY''))"}>} [%_indice_absenteismo] -

{<[gd_eventos_f.load_date] = {">=$(=Date(YearStart(AddYears(Max(gd_eventos_f.load_date), -1)), ''DD.MM.YYYY''))<=$(=Date(YearEnd(AddYears(Max(gd_eventos_f.load_date), -1)), ''DD.MM.YYYY''))"}>}[%_indice_absenteismo])

/

({<[gd_eventos_f.load_date] = {">=$(=Date(YearStart(AddYears(Max(gd_eventos_f.load_date), -1)), ''DD.MM.YYYY''))<=$(=Date(YearEnd(AddYears(Max(gd_eventos_f.load_date), -1)), ''DD.MM.YYYY''))"}>}[%_indice_absenteismo])'

;
 
 
SET %_YoY_horas_nao_planejadas = '({<gd_eventos_f.load_date = {">=$(=Date(YearStart(Max(gd_eventos_f.load_date)), ''DD.MM.YYYY'')) <=$(=Date(YearEnd(Max(gd_eventos_f.load_date)), ''DD.MM.YYYY''))"}>} [%_indice_horas_nao_planejadas] -

{<gd_eventos_f.load_date = {">=$(=Date(YearStart(AddYears(Max(gd_eventos_f.load_date), -1)), ''DD.MM.YYYY''))<=$(=Date(YearEnd(AddYears(Max(gd_eventos_f.load_date), -1)), ''DD.MM.YYYY''))"}>}[%_indice_horas_nao_planejadas])

/

({<gd_eventos_f.load_date = {">=$(=Date(YearStart(AddYears(Max(gd_eventos_f.load_date), -1)), ''DD.MM.YYYY''))<=$(=Date(YearEnd(AddYears(Max(gd_eventos_f.load_date), -1)), ''DD.MM.YYYY''))"}>}[%_indice_horas_nao_planejadas])';
 
SET %_MoM_horas_nao_planejadas = '({<gd_eventos_f.load_date = {">=$(=Date(Monthstart(Max(gd_eventos_f.load_date)), ''DD.MM.YYYY''))<=$(=Date(MonthEnd(Max(gd_eventos_f.load_date)), ''DD.MM.YYYY''))"}>} [%_indice_horas_nao_planejadas] -

{<gd_eventos_f.load_date = {">=$(=Date(MonthStart(AddMonths(Max(gd_eventos_f.load_date), -1)), ''DD.MM.YYYY''))<=$(=Date(Monthend(AddMonths(Max(gd_eventos_f.load_date), -1)), ''DD.MM.YYYY''))"}>}[%_indice_horas_nao_planejadas])

/

({<gd_eventos_f.load_date = {">=$(=Date(MonthStart(AddMonths(Max(gd_eventos_f.load_date), -1)), ''DD.MM.YYYY''))<=$(=Date(Monthend(AddMonths(Max(gd_eventos_f.load_date), -1)), ''DD.MM.YYYY''))"}>}[%_indice_horas_nao_planejadas])';
 
SET %_horas_nao_planejadas_tabela_atual = '{<gd_eventos_f.load_date = {"=$(=Date(AddMonths(Date#(MonthStart(Only(GetFieldSelections(gd_eventos_f.load_date))), ''DD.MM.YYYY''),1), ''DD.MM.YYYY''))"}, ano = {"=$(=Year(Date#(Only(gd_eventos_f.load_date), ''DD.MM.YYYY'')))"}>} [#_horas_nao_planejadas]

/

{<gd_eventos_f.load_date = {"=$(=Date(AddMonths(Date#(MonthStart(Only(GetFieldSelections(gd_eventos_f.load_date))), ''DD.MM.YYYY''),1), ''DD.MM.YYYY''))"},ano = {"=$(=Year(Date#(Only(gd_eventos_f.load_date), ''DD.MM.YYYY'')))"}>} [#_horas_total_jornada_mensal]';
 
 
SET %_horas_nao_planejadas_tabela_ant = '{<gd_eventos_f.load_date = {"=$(=Date(AddMonths(Date#(MonthStart(Only(GetFieldSelections(gd_eventos_f.load_date))), ''DD.MM.YYYY''),1), ''DD.MM.YYYY''))"},ano = {"$(=Year(Date#(Only(gd_eventos_f.load_date), ''DD.MM.YYYY''))) - 1"}>} [#_horas_nao_planejadas]

/

{<gd_eventos_f.load_date = {"=$(=Date(AddMonths(Date#(MonthStart(Only(GetFieldSelections(gd_eventos_f.load_date))), ''DD.MM.YYYY''),1), ''DD.MM.YYYY''))"},ano = {"$(=Year(Date#(Only(gd_eventos_f.load_date), ''DD.MM.YYYY''))) - 1"}>} [#_horas_total_jornada_mensal]';
 
SET %_YoY_horas_nao_planejadas_tabela = '([%_horas_nao_planejadas_tabela] - [%_horas_nao_planejadas_tabela-ant])/[%_horas_nao_planejadas_tabela-ant]';
 
 
SET valor_eventos_faltas = '{<tipo_evento={''Falta'',''Reembolso''}>} [#_valor_evento_total]';
 
 
SET valor_eventos_falta_ano_atual = '{<gd_eventos_f.load_date = {"=$(=Date(AddMonths(Date#(MonthStart(Only(GetFieldSelections(gd_eventos_f.load_date))), ''DD.MM.YYYY''),1), ''DD.MM.YYYY''))"},ano = {"=$(=Year(Date#(Only(gd_eventos_f.load_date), ''DD.MM.YYYY'')))"}>} [#_valor_evento_faltas]';
 
 
SET valor_eventos_falta_ano_anterior ='{<gd_eventos_f.load_date = {"=$(=Date(AddMonths(Date#(MonthStart(Only(GetFieldSelections(gd_eventos_f.load_date))), ''DD.MM.YYYY''),1), ''DD.MM.YYYY''))"},ano = {"$(=Year(AddYears(Date#(Only(gd_eventos_f.load_date), ''DD.MM.YYYY''), -1)))"}>} [#_valor_evento_faltas]';
 
 
SET valor_evento_faltas_operacional = '{<tipo_evento={''Falta'',''Reembolso''}, grupo_relatorio={''8 - Demais''}>} [#_valor_evento_total]';
 
 
SET valor_evento_faltas_nao_operacional = '{<tipo_evento={''Falta'',''Reembolso''}, grupo_relatorio={''7 - Líder''}>} [#_valor_evento_total]';
 
 
SET %_MoM_valor_total_faltas = '({<gd_eventos_f.load_date = {">=$(=Date(Monthstart(Max(gd_eventos_f.load_date)), ''DD.MM.YYYY''))<=$(=Date(MonthEnd(Max(gd_eventos_f.load_date)), ''DD.MM.YYYY''))"}>} #_valor_eventos_falta -

{<gd_eventos_f.load_date = {">=$(=Date(MonthStart(AddMonths(Max(gd_eventos_f.load_date), -1)), ''DD.MM.YYYY''))<=$(=Date(Monthend(AddMonths(Max(gd_eventos_f.load_date), -1)), ''DD.MM.YYYY''))"}>}#_valor_eventos_falta)

/

({<gd_eventos_f.load_date = {">=$(=Date(MonthStart(AddMonths(Max(gd_eventos_f.load_date), -1)), ''DD.MM.YYYY''))<=$(=Date(Monthend(AddMonths(Max(gd_eventos_f.load_date), -1)), ''DD.MM.YYYY''))"}>}#_valor_eventos_falta)';
 
 
SET %_YoY_valor_total_faltas= '({<gd_eventos_f.load_date = {">=$(=Date(YearStart(Max(gd_eventos_f.load_date)), ''DD.MM.YYYY'')) <=$(=Date(YearEnd(Max(gd_eventos_f.load_date)), ''DD.MM.YYYY''))"}>} #_valor_eventos_falta -

{<gd_eventos_f.load_date = {">=$(=Date(YearStart(AddYears(Max(gd_eventos_f.load_date), -1)), ''DD.MM.YYYY''))<=$(=Date(YearEnd(AddYears(Max(gd_eventos_f.load_date), -1)), ''DD.MM.YYYY''))"}>}#_valor_eventos_falta)

/

({<gd_eventos_f.load_date = {">=$(=Date(YearStart(AddYears(Max(gd_eventos_f.load_date), -1)), ''DD.MM.YYYY''))<=$(=Date(YearEnd(AddYears(Max(gd_eventos_f.load_date), -1)), ''DD.MM.YYYY''))"}>}#_valor_eventos_falta)';
 
 
 
SET valor_evento_falta_grafico = '{<gd_eventos_f.load_date = {"=$(=Date(AddMonths(Date#(MonthStart(Only(GetFieldSelections(gd_eventos_f.load_date))), ''DD.MM.YYYY''),1), ''DD.MM.YYYY''))"},ano = {"=$(=Year(Date#(Only(gd_eventos_f.load_date), ''DD.MM.YYYY'')))"}>} [#_valor_eventos_falta]';
 
SET %_indice_abono = '[#_horas_total_abonos]/[#_horas_total_jornada_mensal]';
 
SET %_indice_abono_ano_atual = 

'{<gd_eventos_f.load_date = {"=$(=Date(AddMonths(Date#(MonthStart(Only(GetFieldSelections(gd_eventos_f.load_date))), ''DD.MM.YYYY''),1), ''DD.MM.YYYY''))"},ano = {"=$(=Year(Date#(Only(gd_eventos_f.load_date), ''DD.MM.YYYY'')))"}>}[#_horas_total_abonos]

/

{<gd_eventos_f.load_date = {"=$(=Date(AddMonths(Date#(MonthStart(Only(GetFieldSelections(gd_eventos_f.load_date))), ''DD.MM.YYYY''),1), ''DD.MM.YYYY''))"},ano = {"=$(=Year(Date#(Only(gd_eventos_f.load_date), ''DD.MM.YYYY'')))"}>}[#_horas_total_jornada_mensal]';
 
 
SET %_indice_abono_ano_anterior= '{<gd_eventos_f.load_date = {"=$(=Date(AddMonths(Date#(MonthStart(Only(GetFieldSelections(gd_eventos_f.load_date))), ''DD.MM.YYYY''),1), ''DD.MM.YYYY''))"},ano = {"$(=Year(AddYears(Date#(Only(gd_eventos_f.load_date), ''DD.MM.YYYY''), -1)))"}>}[#_horas_total_abonos]

/

{<gd_eventos_f.load_date = {"=$(=Date(AddMonths(Date#(MonthStart(Only(GetFieldSelections(gd_eventos_f.load_date))), ''DD.MM.YYYY''),1), ''DD.MM.YYYY''))"},ano = {"$(=Year(AddYears(Date#(Only(gd_eventos_f.load_date), ''DD.MM.YYYY''), -1)))"}>}[#_horas_total_jornada_mensal]';
 
 
SET %YoY_indice_abono = '({<gd_eventos_f.load_date = {">=$(=Date(YearStart(Max(gd_eventos_f.load_date)), ''DD.MM.YYYY'')) <=$(=Date(YearEnd(Max(gd_eventos_f.load_date)), ''DD.MM.YYYY''))"}>} [%_indice_abono] -

{<gd_eventos_f.load_date = {">=$(=Date(YearStart(AddYears(Max(gd_eventos_f.load_date), -1)), ''DD.MM.YYYY''))<=$(=Date(YearEnd(AddYears(Max(gd_eventos_f.load_date), -1)), ''DD.MM.YYYY''))"}>}[%_indice_abono])

/

({<gd_eventos_f.load_date = {">=$(=Date(YearStart(AddYears(Max(gd_eventos_f.load_date), -1)), ''DD.MM.YYYY''))<=$(=Date(YearEnd(AddYears(Max(gd_eventos_f.load_date), -1)), ''DD.MM.YYYY''))"}>}[%_indice_abono])';
 
 
SET %MoM_indice_abono = '({<gd_eventos_f.load_date = {">=$(=Date(Monthstart(Max(gd_eventos_f.load_date)), ''DD.MM.YYYY''))<=$(=Date(MonthEnd(Max(gd_eventos_f.load_date)), ''DD.MM.YYYY''))"}>} [%_indice_abono] -

{<gd_eventos_f.load_date = {">=$(=Date(MonthStart(AddMonths(Max(gd_eventos_f.load_date), -1)), ''DD.MM.YYYY''))<=$(=Date(Monthend(AddMonths(Max(gd_eventos_f.load_date), -1)), ''DD.MM.YYYY''))"}>}[%_indice_abono])

/

({<gd_eventos_f.load_date = {">=$(=Date(MonthStart(AddMonths(Max(gd_eventos_f.load_date), -1)), ''DD.MM.YYYY''))<=$(=Date(Monthend(AddMonths(Max(gd_eventos_f.load_date), -1)), ''DD.MM.YYYY''))"}>}[%_indice_abono])';
 
 
SET %_abonos_atual_grafico= '{<gd_eventos_f.load_date = {"=$(=Date(AddMonths(Date#(MonthStart(Only(GetFieldSelections(gd_eventos_f.load_date))), ''DD.MM.YYYY''),1), ''DD.MM.YYYY''))"},ano = {"=$(=Year(Date#(Only(gd_eventos_f.load_date), ''DD.MM.YYYY'')))"}>}[#_horas_total_abonos]

/

{<gd_eventos_f.load_date = {"=$(=Date(AddMonths(Date#(MonthStart(Only(GetFieldSelections(gd_eventos_f.load_date))), ''DD.MM.YYYY''),1), ''DD.MM.YYYY''))"},ano = {"=$(=Year(Date#(Only(gd_eventos_f.load_date), ''DD.MM.YYYY'')))"}>}[#_horas_total_jornada_mensal]';
 
 
SET %_abono_anterior_grafico= '{<gd_eventos_f.load_date = {"=$(=Date(AddMonths(Date#(MonthStart(Only(GetFieldSelections(gd_eventos_f.load_date))), ''DD.MM.YYYY''),1), ''DD.MM.YYYY''))"},ano = {"$(=Year(AddYears(Date#(Only(gd_eventos_f.load_date), ''DD.MM.YYYY''), -1)))"}>}[#_horas_total_abonos]

/

{<gd_eventos_f.load_date = {"=$(=Date(AddMonths(Date#(MonthStart(Only(GetFieldSelections(gd_eventos_f.load_date))), ''DD.MM.YYYY''),1), ''DD.MM.YYYY''))"},ano = {"$(=Year(AddYears(Date#(Only(gd_eventos_f.load_date), ''DD.MM.YYYY''), -1)))"}>}[#_horas_total_jornada_mensal]';

 
TRACE >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>Iniciando carregamento medidas de Banco Horas  <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<;
 
 
SET valor_evento_saldo_banco_pago ='{<codigo_evento = {''695'',''696'',''698''}, mes_nome = {"mar*", "set*"}>} [#_valor_evento_horas_extras]';
 
SET %_colaboradores_com_saldo_banco =  'count({<tipo_evento={''Saldo Banco''}>}distinct pessoa)/count(Total distinct pessoa)';
 
SET %_MAR_SET_pgt_banco= 'If(WildMatch(Date(Max(gd_eventos_f.load_date), ''DD/MM''), ''15/03'', ''15/09''),

(Sum({1<gd_eventos_f.load_date = {">=$(=Date(Monthstart(Max(gd_eventos_f.load_date)), ''DD.MM.YYYY''))<=$(=Date(MonthEnd(Max(gd_eventos_f.load_date)), ''DD.MM.YYYY''))"},codigo_evento={''695'',''698'',''696''}>} gd_eventos_f.valor_evento_total) -

Sum({1<gd_eventos_f.load_date = {">=$(=Date(MonthStart(AddMonths(Max(gd_eventos_f.load_date), -6)), ''DD.MM.YYYY''))<=$(=Date(Monthend(AddMonths(Max(gd_eventos_f.load_date), -6)), ''DD.MM.YYYY''))"}, codigo_evento={''696'',''695'',''698''}>} gd_eventos_f.valor_evento_total))

/

Sum({1<gd_eventos_f.load_date = {">=$(=Date(MonthStart(AddMonths(Max(gd_eventos_f.load_date), -6)), ''DD.MM.YYYY''))<=$(=Date(Monthend(AddMonths(Max(gd_eventos_f.load_date), -6)), ''DD.MM.YYYY''))"}, codigo_evento={''696'',''695'',''698''}>} gd_eventos_f.valor_evento_total)

,

null()

)';
 
 
SET horas_total_saldo_banco = '{<tipo_evento= {''Saldo Banco''}>} [#_hora_total]';
 
SET horas_total_saldo_banco_positivo ='{<tipo_evento= {''Saldo Banco''}, descricao_evento={''SALDO POSITIVO''}>} [#_hora_total]';
 
SET horas_total_saldo_banco_negativo = '{<tipo_evento= {''Saldo Banco''}, descricao_evento={''SALDO NEGATIVO''}>} [#_hora_total]';
 
 
 
 
 
exit script;
 
 